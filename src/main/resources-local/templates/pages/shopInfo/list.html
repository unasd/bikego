<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorator="../layout/default">

<!-- page CSS -->
<th:block layout:fragment="css">
    <style>
        .table-wrapper {
            overflow-x: scroll;
            width: 100%;
        }
        table {
            /*border: solid;*/
            width: 100%;
            table-layout: fixed;
        }
        th{
            border-bottom:2px solid #00bfa5 ;
        }
        td{
            border-bottom:1px solid #FFFFFF ;
        }


        th, td {
            padding: 10px 0 10px;
            text-align: center;

        }

        tr.active {
            color: #26a69a;
        }

        table.striped > tbody > tr:nth-child(odd) {
            background-color: darkslategray;
        }

    </style>
</th:block>

<!-- page 스크립트 -->
<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA[*/
        var resultList = /*[[${resultList}]]*/ "";
        /*]]>*/

        let kakaoMap; // 지도객체
        let marker; // 마커

        function goPage(page){
            $('[name="listForm"]').children('[name="page"]').val(page);
            $('[name="listForm"]').submit();
        }

        function goSearch(){
            $('[name="listForm"]').children('[name="page"]').val(1);
            $('[name="listForm"]').submit();
        }

        $(document).ready(function() {
            $('select').formSelect();
            let container = document.getElementById('kakaoMap');
            let firstPosition;
            if(resultList != '') {
                firstPosition = new kakao.maps.LatLng(resultList[0].latitudeShop, resultList[0].longitudeShop); // 검색 리스트의 첫번째 매장
            } else {
                firstPosition = new kakao.maps.LatLng(37.52983920869157, 126.99756873623262); // 검색결과 없으면 트윅스자전거 매장
            }
            let options = {
                center: firstPosition,
                level: 3 //지도의 레벨(확대, 축소 정도)
            };
            kakaoMap = new kakao.maps.Map(container, options);

            // 매장 위치컬럼 클릭, 매장위치로 마커 이동
            $('.shopLoc').click(function() {
                $('tr').removeClass('active');
                /*[# sec:authorize="hasAuthority('ADMIN')"]*/
                    $(this).parent().addClass('active');
                /*[/]*/
                /*[# sec:authorize="!hasAuthority('ADMIN')"]*/
                    $(this).addClass('active');
                /*[/]*/

                let latitudeAs = $(this).attr('data-lat');
                let longitudeAs = $(this).attr('data-lon');
                // 지도 이동
                let currentPosition = new kakao.maps.LatLng(latitudeAs, longitudeAs);
                kakaoMap.panTo(currentPosition);

                if(typeof(marker) == 'undefined') {
                    // 지도 중심좌표에 마커 생성
                    marker = new kakao.maps.Marker({
                        position: currentPosition
                    });
                    marker.setMap(kakaoMap);
                } else {
                    marker.setPosition(currentPosition);
                }
            });

        });
    </script>
</th:block>

<div layout:fragment="content" class="container">
    <div class="col s12 right-align" style="margin: 1%; min-height: 30px;">
        <a sec:authorize="hasAuthority('ADMIN')" th:href="@{/admin/shopInfo/write.do}" class="large material-icons" style="font-size: 30px; color: rgba(38, 166, 154);">edit</a>
    </div>

    <div id="kakaoMap" class="asMap"></div>


    <div class="row table-wrapper">
        <table >
            <colgroup>
                <col width="120px">
                <col width="300px">
                <col width="120px">
                <col sec:authorize="hasAuthority('ADMIN')" width="50px">
            </colgroup>
            <thead>
            <tr>
                <th class="one wide">매장명</th>
                <th class="ten wide">매장주소</th>
                <th class="two wide">TEL</th>
                <th sec:authorize="hasAuthority('ADMIN')" class="two wide">위치</th>
            </tr>
            </thead>

            <tbody>
            <!-- CONTENTS !-->
            <tr th:each="resultList : ${resultList}" th:class="${#authorization.expression('hasAuthority(''ADMIN'')') ? '' : 'shopLoc'}" th:data-lat="${resultList.latitudeShop}" th:data-lon="${resultList.longitudeShop}">
                <td>
                    <th:block sec:authorize="!hasAuthority('ADMIN')">
                        <span th:text="${resultList.nmShop}"></span>
                    </th:block>
                    <th:block sec:authorize="hasAuthority('ADMIN')">
                        <a th:href="@{/admin/shopInfo/update.do(seqShop=${resultList.seqShop})}">
                            <span th:text="${resultList.nmShop}" th:style="${resultList.ynDel == 'Y' ? 'text-decoration:line-through' : ''}"></span>
                        </a>
                    </th:block>
                </td>
                <td><span th:text="${resultList.addr1Shop + ' ' + resultList.addr2Shop}"></span></td>
                <td><span th:text="${resultList.noTelShop}"></span></td>
                <td sec:authorize="hasAuthority('ADMIN')" th:class="${#authorization.expression('hasAuthority(''ADMIN'')') ? 'shopLoc' : ''}" th:data-lat="${resultList.latitudeShop}" th:data-lon="${resultList.longitudeShop}">
                    <i class="material-icons">explore</i>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <th:block th:if="${not #lists.isEmpty(resultList)}">
        <ul class="pagination">
            <th:block th:if="${pagingResult.hasPrevious}">
                <li class="waves-effect"><a th:onclick="|javascript:goPage('${pagingResult.page-1}');|"><i class="material-icons">chevron_left</i></a></li>
            </th:block>
            <th:block th:unless="${pagingResult.hasPrevious}">
                <li class="disabled"><a><i class="material-icons">chevron_left</i></a></li>
            </th:block>

            <li th:each="pageCount : ${#numbers.sequence(pagingResult.startPage, pagingResult.endPage)}" th:class="${pagingResult.page == pageCount ? 'active' : 'waves-effect'}">
                <th:block th:if="${pagingResult.page == pageCount}"><a th:text="${pageCount}"></a></th:block>
                <th:block th:unless="${pagingResult.page == pageCount}"><a th:onclick="|javascript:goPage('${pageCount}');|" th:text="${pageCount}"></a></th:block>
            </li>

            <th:block th:if="${pagingResult.hasNext}">
                <li class="waves-effect"><a th:onclick="|javascript:goPage('${pagingResult.page+1}');|"><i class="material-icons">chevron_right</i></a></li>
            </th:block>
            <th:block th:unless="${pagingResult.hasNext}">
                <li class="disabled"><a><i class="material-icons">chevron_right</i></a></li>
            </th:block>
        </ul>
    </th:block>
    <div class="row">
        <form name="listForm" method="get" th:with="role=${#authentication.getPrincipal() == 'anonymousUser' ? 'anonymousUser' : #authentication.getPrincipal().getRoleAccount()}"
              th:action="${role == 'ADMIN' ? '/admin/shopInfo/list.do' : '/shopInfo/list.do'}">
            <input type="hidden" name="page" th:value="${pagingResult.page}"/>
            <input type="hidden" name="listSize" th:value="${pagingResult.listSize}"/>
            <input type="hidden" name="pageSize" th:value="${pagingResult.pageSize}"/>
            <input type="hidden" name="direction" th:value="${pagingResult.direction}"/>
            <input type="hidden" name="sortProp" th:value="${pagingResult.sortProp}"/>

            <div class="row">
                <div class="col s12 m8 offset-m2">
                    <div class="row">
                        <div class="input-field col s3">
                            <select name="searchType" class="white-text">
                                <option value="nmShop" th:selected="(${searchDto.searchType} == 'nmShop')">매장명</option>
                                <option value="addr1Shop" th:selected="(${searchDto.searchType} == 'addr1Shop')">매장주소</option>
                            </select>
                        </div>
                        <div class="input-field col s6" >
                            <input style="color: #fff3e0" id="searchKeyword" name="searchKeyword" type="text" class="validate" th:value="${searchDto.searchKeyword}"
                                   onkeypress="if( event.keyCode===13 ){goSearch();}">
                            <label for="searchKeyword">검색어</label>
                        </div>
                        <div class="input-field col s3 left-align">
                            <button class="btn waves-effect waves-light" type="button" id="searchBtn" onclick="javascript:goSearch();">검색</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
</html>
